provider "aws" {
  region = "us-east-1"
}

# ---------------------------------------------------------
# PART 1: SIMPLE IAM SETUP
# ---------------------------------------------------------

# 1. Create a User
resource "aws_iam_user" "my_user" {
  name = "demo_user"
}

# 2. Create a Group
resource "aws_iam_group" "my_group" {
  name = "s3_admins"
}

# 3. Give the Group "Full Access" to S3
# We use the built-in AWS policy so we don't have to write complex code.
resource "aws_iam_group_policy_attachment" "s3_access" {
  group      = aws_iam_group.my_group.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonS3FullAccess"
}

# 4. Add User to the Group
# Now the user has S3 permissions because they are in the group.
resource "aws_iam_user_group_membership" "membership" {
  user  = aws_iam_user.my_user.name
  groups = [aws_iam_group.my_group.name]
}


# ---------------------------------------------------------
# PART 2: S3 BUCKET & WEBSITE
# ---------------------------------------------------------

# 1. Create the Bucket
# Note: Bucket names must be globally unique! Change "my-simple-bucket-123" if it fails.
resource "aws_s3_bucket" "my_bucket" {
  bucket = "my-simple-bucket-123456" 
}

# 2. Ownership (Required for Public Sites)
resource "aws_s3_bucket_ownership_controls" "controls" {
  bucket = aws_s3_bucket.my_bucket.id
  rule {
    object_ownership = "BucketOwnerPreferred"
  }
}

# 3. Turn OFF "Block Public Access" (To allow people to see the website)
resource "aws_s3_bucket_public_access_block" "access_block" {
  bucket = aws_s3_bucket.my_bucket.id
  block_public_acls       = false
  block_public_policy     = false
  ignore_public_acls      = false
  restrict_public_buckets = false
}

# 4. Set Access Control List (ACL) to Public
resource "aws_s3_bucket_acl" "acl" {
  depends_on = [
    aws_s3_bucket_ownership_controls.controls,
    aws_s3_bucket_public_access_block.access_block,
  ]
  bucket = aws_s3_bucket.my_bucket.id
  acl    = "public-read"
}

# 5. Turn on "Static Website Hosting"
resource "aws_s3_bucket_website_configuration" "website" {
  bucket = aws_s3_bucket.my_bucket.id
  index_document {
    suffix = "index.html"
  }
}

# 6. Allow Public Read via Policy
resource "aws_s3_bucket_policy" "policy" {
  bucket = aws_s3_bucket.my_bucket.id
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect    = "Allow"
        Principal = "*"
        Action    = "s3:GetObject"
        Resource  = "${aws_s3_bucket.my_bucket.arn}/*"
      }
    ]
  })
}

# ---------------------------------------------------------
# PART 3: UPLOAD FILE FROM YOUR PC
# ---------------------------------------------------------

# This takes the "index.html" file from your folder and uploads it to S3
resource "aws_s3_object" "upload_file" {
  bucket       = aws_s3_bucket.my_bucket.id
  key          = "index.html"
  source       = "index.html"      # This looks in your local folder
  content_type = "text/html"
  acl          = "public-read"
}


# ---------------------------------------------------------
# PART 4: OUTPUTS
# ---------------------------------------------------------

output "website_url" {
  description = "Click this link to see your website"
  value       = aws_s3_bucket_website_configuration.website.website_endpoint
}