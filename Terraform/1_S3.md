### ğŸ¯ The Logic (Permission Flow)

1.  **Step 1:** Create a User with **NO** permissions.
2.  **Step 2:** Create a Group with **Full S3 Access**.
3.  **Step 3:** Create a **Custom Policy** for "Read-Only S3 Access" and attach it directly to the User.
4.  **Step 4:** Add the User to the Group.
    *   *Result:* The User now has **Read Only** (from direct policy) + **Full Access** (from Group). Effectively, they have Full Access, but this demonstrates how to layer permissions.
5.  **Step 5:** Host the S3 Website.

---

# ğŸŒ Practical: IAM Inheritance & S3 Website

## ğŸ“‚ 1. Files Needed
Create a folder `terraform-iam-s3` and create these two files:
1.  `main.tf` (The code)
2.  `index.html` (The website file)

## ğŸ“ 2. The Website File (`index.html`)
```html
<!DOCTYPE html>
<html>
<head>
    <title>IAM & S3 Demo</title>
</head>
<body>
    <p>This site is hosted on S3.</p>
</body>
</html>
```

## ğŸ’» 3. The Terraform Code (`main.tf`)
Copy this code. Read the comments to understand the permission flow.

```hcl
provider "aws" {
  region = "us-east-1"
}

# ---------------------------------------------------------
# PART 1: IAM SETUP
# ---------------------------------------------------------

# 1. Create a Custom Policy: READ ONLY S3
# We will attach this directly to the user later.
resource "aws_iam_policy" "s3_read_only_policy" {
  name        = "S3ReadOnlyPolicy"
  description = "Policy allowing read access to S3"

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = [
          "s3:Get*",
          "s3:List*"
        ]
        Effect   = "Allow"
        Resource = "*"
      }
    ]
  })
}

# 2. Create a GROUP: Full Access S3
# This group will have high privileges.
resource "aws_iam_group" "s3_full_access_group" {
  name = "S3FullAccessGroup"
}

# Attach AWS Managed "Full Access" Policy to the GROUP
resource "aws_iam_group_policy_attachment" "group_full_s3_attach" {
  group      = aws_iam_group.s3_full_access_group.name
  # This is the official AWS policy for full S3 access
  policy_arn = "arn:aws:iam::aws:policy/AmazonS3FullAccess"
}

# 3. Create a USER with NO Permissions
resource "aws_iam_user" "demo_user" {
  name = "bob_the_builder"
  # No policies attached here. User is blank by default.
}

# 4. Attach READ ONLY Policy Directly to USER
# Now the user has Read permission personally.
resource "aws_iam_user_policy_attachment" "user_read_only_attach" {
  user       = aws_iam_user.demo_user.name
  policy_arn = aws_iam_policy.s3_read_only_policy.arn
}

# 5. Add USER to GROUP
# Now the user inherits the Group's FULL ACCESS permissions.
# Final Permission: User has Read (direct) + Full (group) = Full Access.
resource "aws_iam_user_group_membership" "add_user_to_group" {
  user = aws_iam_user.demo_user.name
  groups = [
    aws_iam_group.s3_full_access_group.name
  ]
}

# ---------------------------------------------------------
# PART 2: S3 STATIC WEBSITE
# ---------------------------------------------------------

# 1. Create S3 Bucket (Ensure name is unique!)
resource "aws_s3_bucket" "website_bucket" {
  bucket = "my-unique-website-bucket-987654" 
}

# 2. Ownership Controls (Required for public websites)
resource "aws_s3_bucket_ownership_controls" "ownership" {
  bucket = aws_s3_bucket.website_bucket.id
  rule {
    object_ownership = "BucketOwnerPreferred"
  }
}

# 3. Public Access Block (Turn OFF blocking)
resource "aws_s3_bucket_public_access_block" "public_access" {
  bucket = aws_s3_bucket.website_bucket.id

  block_public_acls       = false
  block_public_policy     = false
  ignore_public_acls      = false
  restrict_public_buckets = false
}

# 4. Set ACL (Public Read)
resource "aws_s3_bucket_acl" "bucket_acl" {
  depends_on = [
    aws_s3_bucket_ownership_controls.ownership,
    aws_s3_bucket_public_access_block.public_access,
  ]
  bucket = aws_s3_bucket.website_bucket.id
  acl    = "public-read"
}

# 5. Website Configuration
resource "aws_s3_bucket_website_configuration" "website_config" {
  bucket = aws_s3_bucket.website_bucket.id
  index_document {
    suffix = "index.html"
  }
}

# 6. Bucket Policy (Allow public read)
resource "aws_s3_bucket_policy" "allow_public_read" {
  bucket = aws_s3_bucket.website_bucket.id
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid       = "PublicReadGetObject"
        Effect    = "Allow"
        Principal = "*"
        Action    = "s3:GetObject"
        Resource  = "${aws_s3_bucket.website_bucket.arn}/*"
      },
    ]
  })
}

# 7. Upload HTML File
resource "aws_s3_object" "upload_index" {
  bucket       = aws_s3_bucket.website_bucket.id
  key          = "index.html"
  source       = "index.html"
  content_type = "text/html"
  acl          = "public-read"
}

# ---------------------------------------------------------
# PART 3: OUTPUTS
# ---------------------------------------------------------

output "website_url" {
  value = aws_s3_bucket_website_configuration.website_config.website_endpoint
}

output "user_name" {
  value = aws_iam_user.demo_user.name
}

output "user_direct_permissions" {
  value = "Read Only S3 (Direct Policy Attachment)"
}

output "user_inherited_permissions" {
  value = "Full S3 Access (via Group Membership)"
}
```

---

## ğŸš€ 4. Execution Steps

### 1. Initialize
```bash
terraform init
```

### 2. Plan
Check if Terraform detects the 5 IAM resources and 7 S3 resources.
```bash
terraform plan
```

### 3. Apply
```bash
terraform apply
```

---

## âœ… 5. Verification

### A. Check the Website
Copy the `website_url` from the terminal output and open it in your browser. You should see your website.

### B. Check IAM Permissions (The Logic Check)
Go to the AWS Console -> **IAM Service**:

1.  **Check User:** Click on **Users** -> `bob_the_builder`.
    *   Click the **"Permissions"** tab.
    *   You will see **"S3ReadOnlyPolicy"** listed under "Directly attached policies".
    *   You will see **"S3FullAccessGroup"** listed under "User groups".
2.  **Check Group:** Click on **Groups** -> `S3FullAccessGroup`.
    *   Click the **"Permissions"** tab.
    *   You will see **"AmazonS3FullAccess"**.

**Conclusion:** Even though we gave the user "Read Only" directly, adding them to the "Full Access" group gave them the power to Write/Delete as well.

---

## ğŸ§¹ 6. Cleanup
```bash
terraform destroy
```