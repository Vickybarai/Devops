### üéØ The Logic (Permission Flow)

1.  **Step 1:** Create a User with **NO** permissions.
2.  **Step 2:** Create a Group with **Full S3 Access**.
3.  **Step 3:** Create a **Custom Policy** for "Read-Only S3 Access" and attach it directly to the User.
4.  **Step 4:** Add the User to the Group.
    *   *Result:* The User now has **Read Only** (from direct policy) + **Full Access** (from Group). Effectively, they have Full Access, but this demonstrates how to layer permissions.
5.  **Step 5:** Host the S3 Website.

---
---

### üéØ Objective
Deploy a secure S3 Static Website while managing permissions using AWS Identity and Access Management (IAM).
*   Create an IAM User with no direct permissions.
*   Create an IAM Group with Full S3 Access.
*   Add the User to the Group to inherit permissions.
*   Host a public website on S3.

---

### üìÇ Project Structure
We will split the code into modular files for better management, matching the reference structure.

```text
/s3-terraform-project
‚îú‚îÄ‚îÄ provider.tf       # AWS Provider configuration
‚îú‚îÄ‚îÄ variables.tf      # Input Variables (Bucket Name, Tags, etc.)
‚îú‚îÄ‚îÄ iam.tf            # IAM Users, Groups, and Attachments
‚îú‚îÄ‚îÄ s3.tf             # S3 Bucket, Hosting Config, and Upload
‚îî‚îÄ‚îÄ outputs.tf        # Website URL and User Info
```

---


# üåê Project: IAM Identity Management & S3 Static Website

## üìÇ 1. Files Needed
Create a folder `terraform-iam-s3` and create these two files:
1.  `main.tf` (The code)
2.  `index.html` (The website file)

## üìù 2. The Website File (`index.html`)
```html
<!DOCTYPE html>
<html>
<head>
    <title>IAM & S3 Demo</title>
</head>
<body>
    <p>This site is hosted on S3.</p>
</body>
</html>
```



### üöÄ Step-by-Step Implementation

#### Step 1: Define Variables (`variables.tf`)
Define the reusable parameters. The bucket name is set without a default to ensure you provide a unique name.

```hcl


variable "tags" {
  description = "Common tags for resources"
  type        = map(string)
  default = {
    Project     = "TerraformS3"
    Environment = "Dev"
  }
}
```

#### Step 2: Provider Configuration (`provider.tf`)
Set up the AWS provider.

```hcl

provider "aws" {
  region = "us-east-1"
}
```

#### Step 3: IAM Setup (`iam.tf`)
Create the Identity hierarchy. The User inherits S3 permissions only by being added to the Group.

```hcl
# 1. Create IAM Group
resource "aws_iam_group" "s3_admins" {
  name = "S3Admins"
}

# 2. Attach Full S3 Access Policy to Group
resource "aws_iam_group_policy_attachment" "s3_full_access" {
  group      = aws_iam_group.s3_admins.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonS3FullAccess"
}

# 3. Create IAM User (No direct permissions)
resource "aws_iam_user" "web_user" {
  name = "WebAdminUser"
}

# 4. Add User to Group (Inherits S3 Access)
resource "aws_iam_user_group_membership" "admin_membership" {
  user  = aws_iam_user.web_user.name
  groups = [aws_iam_group.s3_admins.name]
}
```

#### Step 4: S3 Bucket & Website Configuration (`s3.tf`)
Create the bucket, configure it for public hosting, and upload the content.

```hcl
# 1. Create S3 Bucket
resource "aws_s3_bucket" "website" {
  bucket = var.bucket_name
  tags   = var.tags
}

# 2. Configure Ownership Controls
resource "aws_s3_bucket_ownership_controls" "ownership" {
  bucket = aws_s3_bucket.website.id
  rule {
    object_ownership = "BucketOwnerPreferred"
  }
}

# 3. Disable Public Access Block
resource "aws_s3_bucket_public_access_block" "public_access" {
  bucket = aws_s3_bucket.website.id

  block_public_acls       = false
  block_public_policy     = false
  ignore_public_acls      = false
  restrict_public_buckets = false
}

# 4. Set Bucket ACL to Public Read
resource "aws_s3_bucket_acl" "bucket_acl" {
  depends_on = [
    aws_s3_bucket_ownership_controls.ownership,
    aws_s3_bucket_public_access_block.public_access,
  ]

  bucket = aws_s3_bucket.website.id
  acl    = "public-read"
}

# 5. Enable Static Website Hosting
resource "aws_s3_bucket_website_configuration" "website_config" {
  bucket = aws_s3_bucket.website.id

  index_document {
    suffix = "index.html"
  }
}

# 6. Bucket Policy (Allow Public Read Access)
resource "aws_s3_bucket_policy" "allow_public_read" {
  bucket = aws_s3_bucket.website.id
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid       = "PublicReadGetObject"
        Effect    = "Allow"
        Principal = "*"
        Action    = "s3:GetObject"
        Resource  = "${aws_s3_bucket.website.arn}/*"
      }
    ]
  })
}

# 7. Upload Website File
# Assumes 'index.html' exists in the same directory
resource "aws_s3_object" "content" {
  bucket       = aws_s3_bucket.website.id
  key          = "index.html"
  source       = "index.html"
  content_type = "text/html"
  acl          = "public-read"
}
```

#### Step 5: Outputs (`outputs.tf`)
Display the critical information after deployment.

```hcl
output "website_endpoint" {
  description = "The URL of the S3 Website"
  value       = aws_s3_bucket_website_configuration.website_config.website_endpoint
}

output "iam_user_name" {
  description = "Name of the created IAM user"
  value       = aws_iam_user.web_user.name
}

output "iam_group_name" {
  description = "Name of the IAM group the user belongs to"
  value       = aws_iam_group.s3_admins.name
}
```

---

### üèÉ Execution Steps

1.  **Prerequisite:** Create an `index.html` file in your project folder.
    ```html
    <h1>S3 Website via Terraform</h1>
    <p>Deployed successfully!</p>
    ```

2.  **Initialize:**
    ```bash
    terraform init
    ```

3.  **Plan:**
    Review the actions. You must provide a unique bucket name here.
    ```bash
    terraform plan -var="bucket_name=my-unique-s3-site-12345"
    ```

4.  **Apply:**
    Deploy the infrastructure.
    ```bash
    terraform apply -var="bucket_name=my-unique-s3-site-12345" -auto-approve
    ```

5.  **Verify:**
    *   Copy the `website_endpoint` output.
    *   Paste it into your browser to see the site.
    *   Check AWS IAM Console to verify `WebAdminUser` is in the `S3Admins` group.

### üí° Key Architectural Takeaways
1.  **IAM Hierarchy:** Users should not have policies attached directly in production. It is best practice to attach policies to Groups and manage Users via Group membership.
2.  **S3 Hosting:** To host a static website, you must explicitly turn off "Block Public Access" and set both the ACL and the Bucket Policy to allow public reads.
3.  **Dependency Management:** Note the use of `depends_on` for the ACL resource to ensure Public Access Block is disabled before ACLs are applied.